/*
 * Copyright (c) 2023.
 *
 * This software is free software;
 *
 * You can redistribute it or modify it under terms of the MIT, Apache License or Zlib license
 */

use zune_core::bytestream::ZCursor;
use zune_jpeg::JpegDecoder;

#[test]
fn eof() {
    let mut decoder = JpegDecoder::new(ZCursor::new([0xff, 0xd8, 0xa4]));

    decoder.decode().unwrap_err();
}

#[test]
fn bad_ff_marker_size() {
    let mut decoder = JpegDecoder::new(ZCursor::new([0xff, 0xd8, 0xff, 0x00, 0x00, 0x00]));

    let _ = decoder.decode().unwrap_err();
}

#[test]
fn bad_number_of_scans() {
    let mut decoder = JpegDecoder::new(ZCursor::new([255, 216, 255, 218, 232, 197, 255]));

    let err = decoder.decode().unwrap_err();

    assert!(
        matches!(err, zune_jpeg::errors::DecodeErrors::SosError(x) if x == "Bad SOS length 59589,corrupt jpeg")
    );
}

#[test]
fn huffman_length_subtraction_overflow() {
    let mut decoder = JpegDecoder::new(ZCursor::new([255, 216, 255, 196, 0, 0]));

    let err = decoder.decode().unwrap_err();

    assert!(
        matches!(err, zune_jpeg::errors::DecodeErrors::FormatStatic(x) if x == "Invalid Huffman length in image")
    );
}

#[test]
fn index_oob() {
    let mut decoder = JpegDecoder::new(ZCursor::new([255, 216, 255, 218, 0, 8, 1, 0, 8, 1]));

    let _ = decoder.decode().unwrap_err();
}

#[test]
fn mul_with_overflow() {
    let mut decoder = JpegDecoder::new(ZCursor::new([
        255, 216, 255, 192, 255, 1, 8, 9, 119, 48, 255, 192
    ]));

    let err = decoder.decode().unwrap_err();

    assert!(
        matches!(err, zune_jpeg::errors::DecodeErrors::SofError(x) if x == "Length of start of frame differs from expected 584,value is 65281")
    );
}



#[test]
fn test_panic_on_slice() {
    const JPEG_DATA: [u8; 1394] = [
        255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 255, 219, 0, 67, 0, 3,
        2, 2, 3, 2, 2, 3, 3, 3, 3, 4, 3, 3, 4, 5, 8, 5, 5, 4, 4, 5, 10, 7, 7, 6, 8, 12, 10, 12, 12, 11,
        10, 11, 11, 13, 14, 18, 16, 13, 14, 17, 14, 11, 11, 16, 22, 16, 17, 19, 20, 21, 21, 21, 12, 15,
        23, 24, 22, 20, 24, 18, 20, 21, 20, 255, 219, 0, 67, 1, 3, 4, 4, 5, 4, 5, 9, 5, 5, 9, 19, 13,
        11, 13, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,
        20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,
        20, 20, 20, 20, 255, 194, 0, 17, 8, 0, 100, 0, 100, 3, 1, 18, 0, 2, 17, 1, 3, 33, 1, 255, 196,
        0, 25, 0, 1, 0, 3, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 7, 8, 9, 4, 255, 196, 0, 40,
        16, 0, 1, 2, 4, 1, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 6, 23, 85, 164, 210, 4, 7, 21, 24,
        25, 86, 99, 102, 162, 163, 165, 211, 225, 227, 255, 196, 0, 26, 1, 1, 1, 0, 3, 1, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 7, 5, 8, 9, 6, 4, 255, 196, 0, 43, 17, 0, 1, 0, 6, 6, 11, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 2, 5, 22, 83, 162, 209, 1, 20, 100, 161, 210, 226, 3, 4, 19, 21, 24, 81,
        82, 97, 101, 163, 227, 255, 218, 0, 12, 3, 1, 0, 2, 17, 3, 0, 0, 0, 0, 83, 2, 0, 100, 0, 40, 0,
        48, 0, 68, 83, 8, 1, 1, 0, 3, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 5, 8, 9, 6, 4, 255,
        196, 46, 55, 0, 8, 0, 24, 0, 85, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 5, 22, 83, 162, 209,
        1, 20, 100, 161, 210, 226, 3, 4, 19, 21, 24, 81, 82, 97, 101, 163, 227, 255, 218, 0, 12, 3, 1,
        0, 2, 17, 3, 0, 0, 0, 0, 83, 2, 0, 100, 0, 40, 0, 48, 0, 68, 83, 8, 0, 49, 46, 48, 92, 49, 46,
        48, 32, 40, 0, 0, 1, 85, 83, 253, 49, 52, 53, 51, 53, 57, 54, 55, 64, 74, 212, 120, 47, 92,
        123, 191, 57, 191, 109, 82, 132, 59, 170, 172, 253, 255, 255, 0, 0, 255, 251, 255, 188, 172,
        247, 255, 166, 189, 173, 160, 185, 170, 179, 179, 215, 255, 249, 255, 170, 172, 253, 255, 255,
        255, 215, 255, 239, 255, 170, 172, 253, 255, 155, 0, 40, 0, 17, 63, 0, 206, 128, 134, 29, 83,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 53, 164, 12, 100, 73, 42, 215, 188, 64, 198, 68, 146, 173, 123, 207,
        89, 81, 213, 250, 1, 1, 85, 83, 2, 0, 8, 82, 184, 125, 10, 56, 68, 12, 100, 73, 42, 215, 188,
        64, 199, 68, 146, 173, 123, 197, 71, 87, 233, 190, 153, 134, 165, 112, 250, 20, 112, 136, 24,
        200, 146, 85, 175, 120, 21, 25, 95, 166, 250, 102, 26, 149, 195, 232, 81, 194, 73, 243, 238,
        227, 159, 208, 207, 187, 142, 127, 68, 233, 185, 179, 71, 148, 231, 143, 19, 94, 31, 223, 241,
        25, 247, 113, 207, 232, 103, 221, 199, 63, 160, 220, 217, 163, 202, 56, 154, 240, 254, 255, 0,
        136, 207, 187, 142, 127, 67, 62, 238, 57, 253, 6, 230, 205, 30, 81, 196, 215, 135, 247, 252,
        70, 125, 220, 115, 250, 25, 247, 113, 207, 232, 55, 54, 104, 242, 142, 38, 188, 63, 191, 226,
        51, 238, 227, 159, 208, 207, 187, 142, 127, 65, 185, 179, 71, 148, 113, 53, 225, 253, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 0, 16, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 95, 214, 78, 225, 14, 220, 50, 254, 178, 119,
        13, 200, 176, 119, 122, 51, 12, 226, 209, 212, 72, 204, 67, 183, 12, 191, 172, 157, 194, 29,
        184, 101, 253, 100, 238, 27, 145, 96, 238, 244, 102, 25, 197, 163, 168, 145, 152, 135, 110, 25,
        127, 89, 59, 132, 59, 112, 203, 250, 201, 220, 55, 34, 193, 221, 232, 204, 51, 139, 71, 81, 35,
        49, 14, 220, 50, 254, 178, 119, 8, 118, 225, 151, 245, 147, 184, 110, 69, 131, 187, 209, 152,
        103, 22, 142, 162, 70, 98, 29, 184, 101, 253, 100, 238, 16, 237, 195, 47, 235, 39, 112, 220,
        139, 7, 119, 163, 48, 206, 45, 29, 68, 140, 196, 59, 112, 203, 250, 201, 220, 6, 228, 88, 59,
        189, 25, 134, 113, 104, 234, 36, 102, 93, 64, 170, 22, 192, 0, 0, 0, 0, 0, 0, 0, 0, 3, 133,
        224, 238, 25, 85, 0, 0, 0, 0, 0, 0, 0, 0, 0, 55, 22, 141, 217, 57, 217, 218, 236, 79, 144, 104,
        221, 147, 157, 157, 174, 196, 249, 13, 127, 106, 87, 15, 161, 71, 9, 150, 216, 104, 249, 13,
        27, 178, 115, 179, 181, 216, 159, 32, 209, 187, 39, 59, 59, 93, 137, 242, 6, 165, 112, 250, 20,
        112, 141, 134, 143, 144, 209, 187, 39, 43, 59, 93, 137, 242, 13, 27, 178, 115, 179, 181, 216,
        159, 32, 106, 87, 15, 161, 71, 8, 216, 72, 250, 149, 236, 103, 31, 140, 238, 196, 0, 1, 0, 110,
        120, 88, 15, 1, 247, 143, 129, 0, 110, 108, 209, 229, 50, 181, 110, 227, 88, 15, 1, 247, 143,
        128, 214, 3, 192, 125, 227, 224, 27, 155, 52, 121, 69, 91, 184, 214, 3, 192, 125, 227, 224, 53,
        128, 240, 31, 120, 248, 6, 230, 205, 30, 81, 86, 238, 53, 128, 240, 31, 120, 248, 13, 96, 60,
        7, 222, 62, 1, 185, 179, 71, 148, 85, 187, 141, 96, 60, 7, 222, 62, 3, 88, 15, 1, 247, 143,
        128, 110, 108, 209, 229, 21, 110, 227, 88, 15, 1, 247, 143, 128, 214, 3, 192, 125, 227, 224,
        27, 155, 52, 121, 69, 91, 184, 214, 3, 192, 125, 227, 224, 3, 115, 102, 143, 40, 171, 119, 49,
        100, 45, 148, 203, 42, 18, 184, 66, 215, 60, 178, 161, 43, 137, 89, 246, 136, 90, 231, 150, 84,
        37, 112, 133, 174, 121, 101, 66, 87, 0, 33, 107, 158, 89, 80, 149, 194, 22, 185, 229, 149, 9,
        92, 0, 133, 174, 121, 101, 66, 87, 8, 90, 231, 150, 84, 37, 112, 2, 22, 185, 229, 149, 9, 92,
        33, 107, 158, 89, 80, 149, 192, 8, 90, 231, 150, 84, 37, 112, 133, 174, 121, 101, 66, 87, 0,
        33, 107, 158, 89, 80, 149, 192, 3, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 171, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 11, 250, 23, 54, 37, 149, 10, 220, 33, 115, 98, 89, 80, 173, 192, 8, 92, 216, 150,
        84, 43, 112, 133, 205, 137, 101, 66, 183, 0, 33, 115, 98, 89, 80, 173, 194, 23, 54, 37, 149,
        10, 220, 0, 133, 205, 137, 101, 66, 183, 8, 92, 216, 150, 84, 43, 112, 2, 23, 54, 37, 149, 10,
        240, 33, 115, 98, 89, 80, 173, 192, 8, 92, 216, 150, 84, 43, 112, 133, 205, 137, 101, 66, 183,
        0, 33, 115, 98, 89, 80, 173, 192, 2, 84, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 63, 255, 217, 0,
    ];
    let  _ = JpegDecoder::new(ZCursor::new(JPEG_DATA)).decode();
}

